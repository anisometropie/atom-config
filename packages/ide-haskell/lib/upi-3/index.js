"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const utils_1 = require("../utils");
tslib_1.__exportStar(require("./instance"), exports);
function consume(pluginManager, options, featureSet) {
    const { name, menu, messageTypes, events, controls, params, tooltip, } = options;
    const disp = new atom_1.CompositeDisposable();
    let messageProvider;
    if (menu) {
        const menuDisp = atom.menu.add([
            {
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: menu.label, submenu: menu.menu }],
            },
        ]);
        disp.add(menuDisp);
    }
    if (messageTypes) {
        if (featureSet.eventsReturnResults) {
            messageProvider = pluginManager.resultsDB.registerProvider(messageTypes !== undefined ? Object.keys(messageTypes) : []);
        }
        for (const type of Object.keys(messageTypes)) {
            const opts = messageTypes[type];
            pluginManager.outputPanel.createTab(type, opts);
        }
    }
    if (events) {
        if (events.onWillSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onWillSaveBuffer, pluginManager.onWillSaveBuffer));
        }
        if (events.onDidSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidSaveBuffer, pluginManager.onDidSaveBuffer));
        }
        if (events.onDidStopChanging) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidStopChanging, pluginManager.onDidStopChanging));
        }
    }
    if (tooltip) {
        let handler;
        let priority;
        let eventTypes;
        if (typeof tooltip === 'function') {
            handler = tooltip;
        }
        else {
            ;
            ({ handler, priority, eventTypes } = tooltip);
        }
        if (priority === undefined) {
            priority = 100;
        }
        disp.add(pluginManager.tooltipRegistry.register(name, {
            priority,
            handler,
            eventTypes,
        }));
    }
    if (controls) {
        for (const i of controls) {
            disp.add(pluginManager.outputPanel.addPanelControl(i));
        }
    }
    if (params) {
        for (const paramName of Object.keys(params)) {
            const spec = params[paramName];
            disp.add(pluginManager.configParamManager.add(name, paramName, spec));
        }
    }
    return disp;
}
exports.consume = consume;
function registerEvent(name, manager, provider, cb, reg) {
    function wrapStatus(cb) {
        return async function (buffer) {
            try {
                manager.backendStatus(name, { status: 'progress', detail: '' });
                const res = await cb(buffer);
                if (provider && Array.isArray(res))
                    provider.setMessages(res);
                manager.backendStatus(name, { status: 'ready', detail: '' });
            }
            catch (e) {
                manager.backendStatus(name, { status: 'warning', detail: `${e}` });
                console.warn(e);
            }
        };
    }
    if (Array.isArray(cb)) {
        const disp = new atom_1.CompositeDisposable();
        for (const i of cb) {
            disp.add(reg(wrapStatus(i)));
        }
        return disp;
    }
    else {
        return reg(wrapStatus(cb));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQWtFO0FBR2xFLG9DQUEwQztBQUsxQyxxREFBMEI7QUFNMUIsaUJBQ0UsYUFBNEIsRUFDNUIsT0FBaUMsRUFDakMsVUFBc0I7SUFFdEIsTUFBTSxFQUNKLElBQUksRUFDSixJQUFJLEVBQ0osWUFBWSxFQUNaLE1BQU0sRUFDTixRQUFRLEVBQ1IsTUFBTSxFQUNOLE9BQU8sR0FDUixHQUFHLE9BQU8sQ0FBQTtJQUNYLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJLGVBQXFDLENBQUE7SUFFekMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNULE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQzdCO2dCQUNFLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ3JEO1NBQ0YsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNqQixFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1lBQ25DLGVBQWUsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUN4RCxZQUFZLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQzVELENBQUE7UUFDSCxDQUFDO1FBRUQsR0FBRyxDQUFDLENB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QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzlCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUM1QixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRCdWZmZXIsIENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQgeyBQbHVnaW5NYW5hZ2VyIH0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQgeyBNQUlOX01FTlVfTEFCRUwgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IFRFdmVudFJhbmdlVHlwZSA9IFVQSS5URXZlbnRSYW5nZVR5cGVcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAnLi4vcmVzdWx0cy1kYi9wcm92aWRlcidcblxuZXhwb3J0ICogZnJvbSAnLi9pbnN0YW5jZSdcblxuZXhwb3J0IGludGVyZmFjZSBGZWF0dXJlU2V0IHtcbiAgZXZlbnRzUmV0dXJuUmVzdWx0czogYm9vbGVhblxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZShcbiAgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcixcbiAgb3B0aW9uczogVVBJLklSZWdpc3RyYXRpb25PcHRpb25zLFxuICBmZWF0dXJlU2V0OiBGZWF0dXJlU2V0LFxuKTogRGlzcG9zYWJsZSB7XG4gIGNvbnN0IHtcbiAgICBuYW1lLFxuICAgIG1lbnUsXG4gICAgbWVzc2FnZVR5cGVzLFxuICAgIGV2ZW50cyxcbiAgICBjb250cm9scyxcbiAgICBwYXJhbXMsXG4gICAgdG9vbHRpcCxcbiAgfSA9IG9wdGlvbnNcbiAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgbGV0IG1lc3NhZ2VQcm92aWRlcjogUHJvdmlkZXIgfCB1bmRlZmluZWRcblxuICBpZiAobWVudSkge1xuICAgIGNvbnN0IG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICAgIHN1Ym1lbnU6IFt7IGxhYmVsOiBtZW51LmxhYmVsLCBzdWJtZW51OiBtZW51Lm1lbnUgfV0sXG4gICAgICB9LFxuICAgIF0pXG4gICAgZGlzcC5hZGQobWVudURpc3ApXG4gIH1cbiAgaWYgKG1lc3NhZ2VUeXBlcykge1xuICAgIGlmIChmZWF0dXJlU2V0LmV2ZW50c1JldHVyblJlc3VsdHMpIHtcbiAgICAgIG1lc3NhZ2VQcm92aWRlciA9IHBsdWdpbk1hbmFnZXIucmVzdWx0c0RCLnJlZ2lzdGVyUHJvdmlkZXIoXG4gICAgICAgIG1lc3NhZ2VUeXBlcyAhPT0gdW5kZWZpbmVkID8gT2JqZWN0LmtleXMobWVzc2FnZVR5cGVzKSA6IFtdLFxuICAgICAgKVxuICAgIH1cbiAgICAvLyBUT0RPOiBtYWtlIGRpc3Bvc2FibGVcbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXMobWVzc2FnZVR5cGVzKSkge1xuICAgICAgY29uc3Qgb3B0cyA9IG1lc3NhZ2VUeXBlc1t0eXBlXVxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICBwbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmNyZWF0ZVRhYih0eXBlLCBvcHRzKVxuICAgIH1cbiAgfVxuICBpZiAoZXZlbnRzKSB7XG4gICAgaWYgKGV2ZW50cy5vbldpbGxTYXZlQnVmZmVyKSB7XG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgcmVnaXN0ZXJFdmVudChcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIsXG4gICAgICAgICAgbWVzc2FnZVByb3ZpZGVyLFxuICAgICAgICAgIGV2ZW50cy5vbldpbGxTYXZlQnVmZmVyLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcixcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICB9XG4gICAgaWYgKGV2ZW50cy5vbkRpZFNhdmVCdWZmZXIpIHtcbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICByZWdpc3RlckV2ZW50KFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlcixcbiAgICAgICAgICBtZXNzYWdlUHJvdmlkZXIsXG4gICAgICAgICAgZXZlbnRzLm9uRGlkU2F2ZUJ1ZmZlcixcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcixcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICB9XG4gICAgaWYgKGV2ZW50cy5vbkRpZFN0b3BDaGFuZ2luZykge1xuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHJlZ2lzdGVyRXZlbnQoXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLFxuICAgICAgICAgIG1lc3NhZ2VQcm92aWRlcixcbiAgICAgICAgICBldmVudHMub25EaWRTdG9wQ2hhbmdpbmcsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlci5vbkRpZFN0b3BDaGFuZ2luZyxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICB9XG4gIH1cbiAgaWYgKHRvb2x0aXApIHtcbiAgICBsZXQgaGFuZGxlcjogVVBJLlRUb29sdGlwSGFuZGxlclxuICAgIGxldCBwcmlvcml0eTogbnVtYmVyIHwgdW5kZWZpbmVkXG4gICAgbGV0IGV2ZW50VHlwZXM6IFRFdmVudFJhbmdlVHlwZVtdIHwgdW5kZWZpbmVkXG4gICAgaWYgKHR5cGVvZiB0b29sdGlwID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBoYW5kbGVyID0gdG9vbHRpcFxuICAgIH0gZWxzZSB7XG4gICAgICA7KHsgaGFuZGxlciwgcHJpb3JpdHksIGV2ZW50VHlwZXMgfSA9IHRvb2x0aXApXG4gICAgfVxuICAgIGlmIChwcmlvcml0eSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBwcmlvcml0eSA9IDEwMFxuICAgIH1cbiAgICBkaXNwLmFkZChcbiAgICAgIHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnJlZ2lzdGVyKG5hbWUsIHtcbiAgICAgICAgcHJpb3JpdHksXG4gICAgICAgIGhhbmRsZXIsXG4gICAgICAgIGV2ZW50VHlwZXMsXG4gICAgICB9KSxcbiAgICApXG4gIH1cbiAgaWYgKGNvbnRyb2xzKSB7XG4gICAgZm9yIChjb25zdCBpIG9mIGNvbnRyb2xzKSB7XG4gICAgICBkaXNwLmFkZChwbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbChpKSlcbiAgICB9XG4gIH1cbiAgaWYgKHBhcmFtcykge1xuICAgIGZvciAoY29uc3QgcGFyYW1OYW1lIG9mIE9iamVjdC5rZXlzKHBhcmFtcykpIHtcbiAgICAgIGNvbnN0IHNwZWMgPSBwYXJhbXNbcGFyYW1OYW1lXVxuICAgICAgZGlzcC5hZGQocGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuYWRkKG5hbWUsIHBhcmFtTmFtZSwgc3BlYykpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRpc3Bcbn1cblxuZnVuY3Rpb24gcmVnaXN0ZXJFdmVudChcbiAgbmFtZTogc3RyaW5nLFxuICBtYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICBwcm92aWRlcjogUHJvdmlkZXIgfCB1bmRlZmluZWQsXG4gIGNiOiBVUEkuVFNpbmdsZU9yQXJyYXk8VVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2s+LFxuICByZWc6IChjYjogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+IERpc3Bvc2FibGUsXG4pIHtcbiAgZnVuY3Rpb24gd3JhcFN0YXR1cyhjYjogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24oYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgICB0cnkge1xuICAgICAgICBtYW5hZ2VyLmJhY2tlbmRTdGF0dXMobmFtZSwgeyBzdGF0dXM6ICdwcm9ncmVzcycsIGRldGFpbDogJycgfSlcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgY2IoYnVmZmVyKVxuICAgICAgICBpZiAocHJvdmlkZXIgJiYgQXJyYXkuaXNBcnJheShyZXMpKSBwcm92aWRlci5zZXRNZXNzYWdlcyhyZXMpXG4gICAgICAgIG1hbmFnZXIuYmFja2VuZFN0YXR1cyhuYW1lLCB7IHN0YXR1czogJ3JlYWR5JywgZGV0YWlsOiAnJyB9KVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBtYW5hZ2VyLmJhY2tlbmRTdGF0dXMobmFtZSwgeyBzdGF0dXM6ICd3YXJuaW5nJywgZGV0YWlsOiBgJHtlfWAgfSlcbiAgICAgICAgY29uc29sZS53YXJuKGUpXG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChBcnJheS5pc0FycmF5KGNiKSkge1xuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZm9yIChjb25zdCBpIG9mIGNiKSB7XG4gICAgICBkaXNwLmFkZChyZWcod3JhcFN0YXR1cyhpKSkpXG4gICAgfVxuICAgIHJldHVybiBkaXNwXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlZyh3cmFwU3RhdHVzKGNiKSlcbiAgfVxufVxuIl19